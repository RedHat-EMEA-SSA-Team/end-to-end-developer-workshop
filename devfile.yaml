schemaVersion: 2.1.0
metadata:
  name: wksp-end-to-end-dev
projects:
  - git:
      checkoutFrom:
        revision: '6.2'
      remotes:
        origin: 'https://github.com/RedHat-EMEA-SSA-Team/end-to-end-developer-workshop.git'
    name: workshop
components:
  - container:
      args:
        - sh
        - '-c'
        - '${PLUGIN_REMOTE_ENDPOINT_EXECUTABLE}'
      endpoints:
        - attributes:
            protocol: http
          exposure: public
          name: 8080-port
          protocol: http
          targetPort: 8080
        - attributes:
            protocol: http
          exposure: public
          name: 9000-port
          protocol: http
          targetPort: 9000
        - attributes:
            protocol: http
            public: 'false'
          exposure: internal
          name: 5005-port
          protocol: http
          targetPort: 5005
      env:
        - name: MAVEN_OPTS
          value: '-Xmx2048m -Duser.home=/home/developer'
        - name: MAVEN_MIRROR_URL
          value: 'http://nexus.opentlc-shared.svc:8081/repository/maven-all-public'
        - name: PLUGIN_REMOTE_ENDPOINT_EXECUTABLE
          value: /remote-endpoint/plugin-remote-endpoint
        - name: THEIA_PLUGINS
          value: 'local-dir:///plugins/sidecars/workshop-tools'
      image: 'quay.io/redhat-emea-ssa-team/workshop-tools:6.1'
      memoryLimit: 2084M
      mountSources: true
      sourceMapping: /projects
      volumeMounts:
        - name: kubefolder
          path: /home/developer/.kube
        - name: m2
          path: /home/jboss/.m2
        - name: gradle
          path: /home/jboss/.gradle
        - name: plugins
          path: /plugins
    name: workshop-tools
  - name: kubefolder
    volume: {}
  - name: m2
    volume: {}
  - name: gradle
    volume: {}
commands:
  - exec:
      commandLine: 'odo login $(oc whoami --show-server) --username=${DEVWORKSPACE_NAMESPACE%-codeready} --password=openshift --insecure-skip-tls-verify'
      component: workshop-tools
      label: OpenShift - Login
      workingDir: /projects/workshop
    id: openshift---login
  - exec:
      commandLine: 'odo project create my-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}'
      component: workshop-tools
      label: OpenShift - Create Development Project
      workingDir: /projects/workshop
    id: openshift---create-development-project
  - exec:
      commandLine: '[[ ! -z "$(ps aux | grep -v grep | grep "compile quarkus:dev" | awk ''{print $2}'')" ]] &&  echo ''!! Application already running in Dev Mode !!'' ||  mvn compile quarkus:dev -Ddebug=false'
      component: workshop-tools
      label: Inventory - Compile (Dev Mode)
      workingDir: /projects/workshop/labs/inventory-quarkus
    id: inventory---compile-dev-mode
  - exec:
      commandLine: mvn clean package -DskipTests
      component: workshop-tools
      label: Inventory - Build
      workingDir: /projects/workshop/labs/inventory-quarkus
    id: inventory---build
  - exec:
      commandLine: 'odo create --app coolstore --project my-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}'
      component: workshop-tools
      label: Inventory - Create Component
      workingDir: /projects/workshop/labs/inventory-quarkus
    id: inventory---create-component
  - exec:
      commandLine: odo push
      component: workshop-tools
      label: Inventory - Push
      workingDir: /projects/workshop/labs/inventory-quarkus
    id: inventory---push
  - exec:
      commandLine: mvn clean package -DskipTests
      component: workshop-tools
      label: Catalog - Build
      workingDir: /projects/workshop/labs/catalog-spring-boot
    id: catalog---build
  - exec:
      commandLine: 'mvn spring-boot:run'
      component: workshop-tools
      label: Catalog - Run
      workingDir: /projects/workshop/labs/catalog-spring-boot
    id: catalog---run
  - exec:
      commandLine: 'odo create --app coolstore --project my-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}'
      component: workshop-tools
      label: Catalog - Create Component
      workingDir: /projects/workshop/labs/catalog-spring-boot
    id: catalog---create-component
  - exec:
      commandLine: odo push
      component: workshop-tools
      label: Catalog - Push
      workingDir: /projects/workshop/labs/catalog-spring-boot
    id: catalog---push
  - exec:
      commandLine: 'odo create --app coolstore --project my-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}'
      component: workshop-tools
      label: Gateway - Create Component
      workingDir: /projects/workshop/labs/gateway-dotnet
    id: gateway---create-component
  - exec:
      commandLine: odo push
      component: workshop-tools
      label: Gateway - Push
      workingDir: /projects/workshop/labs/gateway-dotnet
    id: gateway---push
  - exec:
      commandLine: 'for i in {1..60}; do if [ $(curl -s -w "%{http_code}" -o /dev/null http://catalog-coolstore.my-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}.svc:8080/actuator/health) == "200" ]; then MSG="\\033[0;32mThe request to Catalog Service has succeeded\\033[0m"; else MSG="\\033[0;31mERROR - The request to Catalog Service has failed\\033[0m"; fi;echo -e $MSG;sleep 2s; done'
      component: workshop-tools
      label: Catalog - Generate Traffic
      workingDir: /projects/workshop/labs/catalog-spring-boot
    id: catalog---generate-traffic
  - exec:
      commandLine: 'oc patch deployment/catalog-coolstore -n my-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}} --patch ''{"spec": {"template": {"spec": {"affinity": {"podAffinity": {"requiredDuringSchedulingIgnoredDuringExecution": [{"labelSelector": { "matchExpressions": [{"key" : "component", "operator" : "In", "values": ["catalog"]}]}, "topologyKey" : "kubernetes.io/hostname"}]}}}}}}'''
      component: workshop-tools
      label: Catalog - Add PodAffinity
      workingDir: /projects/workshop/labs/catalog-spring-boot
    id: catalog---add-podaffinity
  - exec:
      commandLine: 'oc project my-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}; oc set probe deployment/gateway-coolstore  --liveness --readiness --period-seconds=5 --get-url=http://:8080/health;oc set probe deployment/web-coolstore  --liveness --readiness --period-seconds=5 --get-url=http://:8080/;echo "Health Probes Done"'
      component: workshop-tools
      label: Probes - Configure Gateway & Web
      workingDir: /projects/workshop
    id: probes---configure-gateway--web
  - exec:
      commandLine: './gateway_generate_traffic.sh cn-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}'
      component: workshop-tools
      label: Gateway - Generate Traffic
      workingDir: /projects/workshop/.tasks
    id: gateway---generate-traffic
  - exec:
      commandLine: './inner_loop_deploy_coolstore.sh my-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}'
      component: workshop-tools
      label: Inner Loop - Deploy Coolstore
      workingDir: /projects/workshop/.tasks
    id: inner-loop---deploy-coolstore
  - exec:
      commandLine: 'git init; git remote add origin http://gitea-server.gitea.svc:3000/${DEVWORKSPACE_NAMESPACE%-codeready}/inventory-quarkus.git; git add *; git commit -m "Initial"; git push http://${DEVWORKSPACE_NAMESPACE%-codeready}:openshift@gitea-server.gitea.svc:3000/${DEVWORKSPACE_NAMESPACE%-codeready}/inventory-quarkus.git'
      component: workshop-tools
      label: Inventory - Commit
      workingDir: /projects/workshop/labs/inventory-quarkus
    id: inventory---commit
  - exec:
      commandLine: './gitops_export_coolstore.sh my-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}} cn-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}'
      component: workshop-tools
      label: GitOps - Export Coolstore
      workingDir: /projects/workshop/.tasks
    id: gitops---export-coolstore
  - exec:
      commandLine: 'oc project cn-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}} && ./pipeline_deploy_coolstore.sh cn-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}'
      component: workshop-tools
      label: Pipeline - Deploy Coolstore
      workingDir: /projects/workshop/.tasks
    id: pipeline---deploy-coolstore
  - exec:
      commandLine: 'git init; git remote add origin http://gitea-server.gitea.svc:3000/${DEVWORKSPACE_NAMESPACE%-codeready}/inventory-gitops.git 2> /dev/null; git add *; git commit -m "Initial Inventory GitOps"; git push http://${DEVWORKSPACE_NAMESPACE%-codeready}:openshift@gitea-server.gitea.svc:3000/${DEVWORKSPACE_NAMESPACE%-codeready}/inventory-gitops.git'
      component: workshop-tools
      label: GitOps - Commit Inventory
      workingDir: /projects/workshop/labs/gitops/inventory-coolstore
    id: gitops---commit-inventory
  - exec:
      commandLine: './gitops_commit_configure_coolstore.sh ${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}'
      component: workshop-tools
      label: GitOps - Commit & Configure Coolstore
      workingDir: /projects/workshop/.tasks
    id: gitops---commit--configure-coolstore
  - exec:
      commandLine: 'oc patch deployment/catalog-coolstore --patch ''{"spec": {"template": {"metadata": {"annotations": {"sidecar.istio.io/inject": "true"}}}}}'' -n cn-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}} && oc patch deployment/gateway-coolstore --patch ''{"spec": {"template": {"metadata": {"annotations": {"sidecar.istio.io/inject": "true"}}}}}'' -n cn-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}} '
      component: workshop-tools
      label: Service Mesh - Deploy Catalog and Gateway
    id: service-mesh---deploy-catalog-and-gateway
  - exec:
      commandLine: 'git checkout .; git clean -fd; git clean -f; oc delete project my-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}; oc delete deployment,deploymentconfig,buildconfig,imagestream,route,secret,configmap,pvc,service,pipeline,pipelinerun --all --namespace cn-project${DEVWORKSPACE_NAMESPACE:4:${DEVWORKSPACE_NAMESPACE}-14}}'
      component: workshop-tools
      label: OpenShift - Cleanup
      workingDir: /projects/workshop
    id: openshift---cleanup
